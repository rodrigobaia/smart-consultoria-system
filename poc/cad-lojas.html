<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POC — Cadastro de Lojas</title>
  <link rel="stylesheet" href="./css/styles.css" />
</head>

<body>
  <div id="app"></div>

  <div id="content" style="display:none">
    <section class="view">
      <div id="crudRoot"></div>
    </section>
  </div>

  <script src="./js/poc.js"></script>
  <script src="./js/store.js"></script>
  <script src="./js/crud-page.js"></script>
  <script>
    Poc.requireAuth({ allowRoles: ["Administrador", "Gestor"] });
    Poc.renderShell({ activeRoute: "cad-lojas" });

    const allProds = PocStore.load("produtos");
    const allColabs = PocStore.load("colaboradores");

    // Filtra colaboradores por perfil
    const operadores = allColabs.filter(c => {
      const u = PocStore.load("usuarios").find(usr => usr.username === c.usuario);
      return u && u.perfil === "Operador";
    });
    const consultores = allColabs.filter(c => {
      const u = PocStore.load("usuarios").find(usr => usr.username === c.usuario);
      return u && u.perfil === "Consultoria";
    });

    PocCrudPage.render({
      entityKey: "lojas",
      title: "Cadastro de Lojas",
      tabs: [
        { key: "dados", label: "Dados da Loja" },
        { key: "socios", label: "Dados do Sócio" },
        { key: "operadores", label: "Operadores" },
        { key: "consultores", label: "Consultores" },
        { key: "financeiro", label: "Financeiro" },
      ],
      fields: [
        // ABA: Dados
        { tab: "dados", key: "razaoSocial", label: "Razão Social", required: true, placeholder: "Razão Social completa" },
        { tab: "dados", key: "nomeFantasia", label: "Nome Fantasia", required: true, placeholder: "Nome fantasia" },
        { tab: "dados", key: "cnpj", label: "CNPJ", required: true, placeholder: "00.000.000/0000-00" },
        { tab: "dados", key: "email", label: "E-mail", type: "email", required: true, placeholder: "e-mail de contato" },
        { tab: "dados", key: "telefone", label: "Telefone", required: true, placeholder: "(00) 00000-0000" },
        { tab: "dados", key: "chavePix", label: "Chave PIX", placeholder: "CNPJ, E-mail, Celular ou Aleatória" },
        { tab: "dados", key: "status", label: "Status", type: "select", options: ["Ativo", "Inativo"] },

        // ABA: Financeiro (campos base)
        { tab: "financeiro", key: "mensalidade", label: "Valor da Mensalidade", type: "text", placeholder: "0,00", prefix: "R$" },
      ],
      onAfterRenderForm: (root, editId) => {
        const itemToEdit = editId ? PocStore.load("lojas").find(x => x.id === editId) : null;

        // --- MÁSCARAS ---
        const inputCnpj = document.getElementById("f_cnpj");
        const inputTel = document.getElementById("f_telefone");
        const inputMensal = document.getElementById("f_mensalidade");

        const maskCnpj = (v) => {
          v = v.replace(/\D/g, "").substring(0, 14);
          if (v.length <= 2) return v;
          if (v.length <= 5) return v.replace(/^(\d{2})(\d)/, "$1.$2");
          if (v.length <= 8) return v.replace(/^(\d{2})(\d{3})(\d)/, "$1.$2.$3");
          if (v.length <= 12) return v.replace(/^(\d{2})(\d{3})(\d{3})(\d)/, "$1.$2.$3/$4");
          return v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d)/, "$1.$2.$3/$4-$5");
        };

        const maskTel = (v) => {
          v = v.replace(/\D/g, "").substring(0, 11);
          if (v.length <= 2) return v;
          if (v.length <= 6) return v.replace(/^(\d{2})(\d)/, "($1) $2");
          if (v.length <= 10) return v.replace(/^(\d{2})(\d{4})(\d)/, "($1) $2-$3");
          return v.replace(/^(\d{2})(\d{5})(\d)/, "($1) $2-$3");
        };

        const maskMoeda = (val) => {
          let v = val.replace(/\D/g, '');
          if (v === "") return "";
          let n = parseInt(v, 10) / 100;
          return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        if (inputCnpj) inputCnpj.oninput = (e) => e.target.value = maskCnpj(e.target.value);
        if (inputTel) inputTel.oninput = (e) => e.target.value = maskTel(e.target.value);
        if (inputMensal) {
          inputMensal.oninput = (e) => e.target.value = maskMoeda(e.target.value);
          if (inputMensal.value) inputMensal.value = maskMoeda(inputMensal.value.replace('.', ''));
        }

        // --- ABA: SÓCIOS (DINÂMICO) ---
        const sociosHost = document.getElementById("customTabContent_socios");
        let sociosData = itemToEdit?.socios || [];

        function renderSocios() {
          sociosHost.innerHTML = `
            <div style="margin-top:10px;">
              <div class="assocList" id="sociosList">
                ${sociosData.map((s, idx) => `
                  <div class="assocItem">
                    <div class="assocItem__info">
                      <strong>${Poc.escapeHtml(s.nome)}</strong>
                      <small>${Poc.escapeHtml(s.email)} • ${Poc.escapeHtml(s.telefone)}</small>
                    </div>
                    <button class="btn btn--ghost" type="button" onclick="window.removeSocio(${idx})" style="color:var(--danger)">Remover</button>
                  </div>
                `).join("")}
                ${sociosData.length === 0 ? '<p class="muted" style="padding:10px; text-align:center;">Nenhum sócio cadastrado.</p>' : ''}
              </div>
              <div class="card" style="margin-top:16px; padding:12px; background:var(--panel2); border:1px dashed var(--border);">
                <div class="grid grid--2" style="gap:12px;">
                  <label class="field">
                    <span>Nome do Sócio</span>
                    <input type="text" id="soc_nome" placeholder="Ex.: João Silva" />
                  </label>
                  <label class="field">
                    <span>E-mail</span>
                    <input type="email" id="soc_email" placeholder="joao@email.com" />
                  </label>
                  <label class="field">
                    <span>Telefone</span>
                    <input type="text" id="soc_tel" placeholder="(00) 00000-0000" />
                  </label>
                </div>
                <button type="button" class="btn btn--primary" style="margin-top:16px; width:100%;" onclick="window.addSocio()">+ Adicionar Sócio à Lista</button>
              </div>
            </div>
          `;

          const sTel = document.getElementById("soc_tel");
          if (sTel) sTel.oninput = (e) => e.target.value = maskTel(e.target.value);
        }

        window.addSocio = () => {
          const nome = document.getElementById("soc_nome").value.trim();
          const email = document.getElementById("soc_email").value.trim();
          const tel = document.getElementById("soc_tel").value.trim();
          if (!nome || !email || !tel) return Poc.toast("Preencha todos os dados do sócio", "bad");
          sociosData.push({ nome, email, telefone: tel });
          renderSocios();
        };

        window.removeSocio = (idx) => {
          sociosData.splice(idx, 1);
          renderSocios();
        };

        renderSocios();

        // --- ABA: ASSOCIAÇÕES ---
        const opHost = document.getElementById("customTabContent_operadores");
        const conHost = document.getElementById("customTabContent_consultores");
        let itemOperadores = itemToEdit?.operadores || [];
        let itemConsultores = itemToEdit?.consultores || [];

        function renderAssoc(host, list, currentIds, type) {
          host.innerHTML = `
            <div class="assocList" style="margin-top:10px;">
              ${list.map(c => {
            const checked = currentIds.includes(c.id) ? 'checked' : '';
            return `
                  <label class="assocItem" style="cursor:pointer;">
                    <div class="assocItem__info">
                      <strong>${Poc.escapeHtml(c.nome)}</strong>
                      <small>CPF: ${Poc.escapeHtml(c.cpf)}</small>
                    </div>
                    <input type="checkbox" data-assoc-type="${type}" data-assoc-id="${c.id}" ${checked} />
                  </label>
                `;
          }).join("")}
              ${list.length === 0 ? `<p class="muted" style="padding:10px; text-align:center;">Nenhum colaborador do tipo ${type} cadastrado.</p>` : ''}
            </div>
          `;
        }

        renderAssoc(opHost, operadores, itemOperadores, "Operador");
        renderAssoc(conHost, consultores, itemConsultores, "Consultoria");

        // --- ABA: FINANCEIRO (PRODUTOS) ---
        const finHost = document.getElementById("customTabContent_financeiro");
        let finData = itemToEdit?.configFinanceira || {};

        finHost.innerHTML = `
          <h2 style="margin-top:24px; font-size:1rem;">Comissões por Produto</h2>
          <div class="grid" style="gap:10px; margin-top:10px;">
            ${allProds.map(p => {
          const val = finData[p.id] || "";
          const label = p.tipoComissao === "Percentual" ? "Percentual" : "Valor";
          const mark = p.tipoComissao === "Percentual" ? "%" : "R$";
          return `
                <div class="card" style="padding:12px; margin:0; background:var(--bg); border-left:4px solid var(--primary);">
                  <div class="row row--between">
                    <div>
                      <strong>${Poc.escapeHtml(p.descricao)}</strong><br/>
                      <small class="muted">${Poc.escapeHtml(p.codigo)}</small>
                    </div>
                    <div style="display:flex; align-items:center; gap:6px;">
                      <span>${label}:</span>
                      <div style="display:flex; border:1px solid var(--border); border-radius:8px; overflow:hidden; background:var(--panel);">
                        ${mark === 'R$' ? `<span style="padding:0 8px; background:var(--panel2); border-right:1px solid var(--border); display:flex; align-items:center; font-size:12px;">R$</span>` : ''}
                        <input type="text" 
                               data-prod-id="${p.id}" 
                               class="prod-comm"
                               value="${Poc.escapeHtml(val)}" 
                               style="width:80px; border:none; padding:6px; outline:none;" 
                               placeholder="0,00" />
                        ${mark === '%' ? `<span style="padding:0 8px; background:var(--panel2); border-left:1px solid var(--border); display:flex; align-items:center; font-size:12px;">%</span>` : ''}
                      </div>
                    </div>
                  </div>
                </div>
              `;
        }).join("")}
          </div>
        `;

        document.querySelectorAll(".prod-comm").forEach(inp => {
          inp.oninput = (e) => e.target.value = maskMoeda(e.target.value);
        });

        // --- EXPOR DADOS PARA O SAVE ---
        window._getCustomLojasData = () => {
          const ops = Array.from(document.querySelectorAll('input[data-assoc-type="Operador"]:checked')).map(i => i.getAttribute("data-assoc-id"));
          const cons = Array.from(document.querySelectorAll('input[data-assoc-type="Consultoria"]:checked')).map(i => i.getAttribute("data-assoc-id"));
          const comms = {};
          document.querySelectorAll(".prod-comm").forEach(inp => {
            comms[inp.getAttribute("data-prod-id")] = inp.value;
          });

          return {
            socios: sociosData,
            operadores: ops,
            consultores: cons,
            configFinanceira: comms
          };
        };
      },
      onSave: (data, done) => {
        const custom = window._getCustomLojasData();
        const finalData = { ...data, ...custom };

        // Normaliza moeda
        if (finalData.mensalidade) {
          finalData.mensalidade = parseFloat(finalData.mensalidade.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        }

        if (data.id) {
          PocStore.update("lojas", data.id, finalData);
        } else {
          PocStore.add("lojas", finalData);
        }
        Poc.toast("Loja salva com sucesso!", "ok");
        done();
      }
    });
  </script>
</body>

</html>